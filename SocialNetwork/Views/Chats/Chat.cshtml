@model SocialNetwork.Models.DTO.ChatDTO

@{
    ViewData["Title"] = Model.Name;
}

<div class="chat-container">
    <div class="chat-header">
        <button class="btn btn-link" onclick="history.back()">
            <i class="fas fa-arrow-left"></i>
        </button>
        <div>
            <h3>@Model.Name</h3>
            <p>@Model.Description</p>
        </div>
        <div>
            <button class="btn btn-info" data-toggle="modal" data-target="#editChatModal">Edit</button>
            <button class="btn btn-primary" data-toggle="modal" data-target="#partyChatModal">Party</button>
        </div>
    </div>

    <div class="chat-messages" id="messagesList">
        @foreach (var message in Model.Messages)
        {
            <div class="chat-message">
                <strong>@message.SenderId</strong>
                <small>@message.Timestamp.ToString("g")</small>
                <p>@message.Content</p>
            </div>
        }
    </div>

    <div class="send-message-form">
        <form id="sendMessageForm">
            <div class="form-group">
                <input type="text" id="messageInput" class="form-control" placeholder="Type a message..." />
                <button type="submit" class="btn btn-primary"><i class="fas fa-arrow-right"></i></button>
            </div>
        </form>
    </div>
</div>

<!-- Edit Chat Modal -->
<div class="modal fade" id="editChatModal" tabindex="-1" role="dialog" aria-labelledby="editChatModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editChatModalLabel">Edit Chat</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="editChatForm">
                    <div class="form-group">
                        <label for="editChatName">Chat Name</label>
                        <input type="text" class="form-control" id="editChatName" value="@Model.Name" />
                    </div>
                    <div class="form-group">
                        <label for="editChatDescription">Description</label>
                        <textarea class="form-control" id="editChatDescription">@Model.Description</textarea>
                    </div>
                    <div class="form-group">
                        <label for="editChatIconUrl">Chat Icon URL</label>
                        <input type="text" class="form-control" id="editChatIconUrl" value="@Model.ChatIconUrl" />
                    </div>
                    <button type="button" class="btn btn-primary" onclick="editChat(@Model.Id)">Save changes</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Party Chat Modal -->
<div class="modal fade" id="partyChatModal" tabindex="-1" role="dialog" aria-labelledby="partyChatModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="partyChatModalLabel">Party</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <ul class="list-group">
                    @foreach (var participant in Model.Participants)
                    {
                        <li class="list-group-item">
                            <img src="@participant.ProfilePictureUrl" alt="Profile Picture" class="avatar-small" />
                            @participant.FullName
                        </li>
                    }
                </ul>
                <button type="button" class="btn btn-primary mt-3" data-toggle="modal" data-target="#addParticipantModal">Invite</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Participant Modal -->
<div class="modal fade" id="addParticipantModal" tabindex="-1" role="dialog" aria-labelledby="addParticipantModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addParticipantModalLabel">Add Participant</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="addParticipantForm">
                    <div class="form-group">
                        <label for="addParticipant">Select Participant</label>
                        <select class="form-control" id="addParticipant" style="width: 100%;"></select>
                    </div>
                    <button type="button" class="btn btn-primary" onclick="addParticipant(@Model.Id)">Add</button>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/lib/microsoft/signalr/dist/browser/signalr.js"></script>
    <script>
        const connection = new signalR.HubConnectionBuilder().withUrl("/chathub").build();

        connection.on("ReceiveMessage", function (user, message) {
            const msg = `<div class="chat-message"><strong>${user}</strong>: ${message}</div>`;
            document.getElementById("messagesList").innerHTML += msg;
        });

        connection.start().catch(function (err) {
            return console.error(err.toString());
        });

        document.getElementById("sendMessageForm").addEventListener("submit", function (event) {
            event.preventDefault();
            const messageInput = document.getElementById("messageInput");
            const message = messageInput.value;
            const chatId = @Model.Id;

            fetch(`/Chats/SendMessage?chatId=${chatId}&message=${message}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                }
            }).then(response => {
                if (response.ok) {
                    messageInput.value = '';
                } else {
                    alert("Failed to send message");
                }
            });
        });

        $(document).ready(function () {
            $('#addParticipant').select2({
                placeholder: 'Select Participant',
                ajax: {
                    url: '/Users/GetUsers',
                    dataType: 'json',
                    processResults: function (data) {
                        return {
                            results: $.map(data, function (user) {
                                return {
                                    id: user.id,
                                    text: user.username
                                };
                            })
                        };
                    }
                }
            });
        });

        function editChat(chatId) {
            var name = $('#editChatName').val();
            var description = $('#editChatDescription').val();
            var iconUrl = $('#editChatIconUrl').val();

            $.ajax({
                url: '/Chats/Edit',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    Id: chatId,
                    Name: name,
                    Description: description,
                    ChatIconUrl: iconUrl
                }),
                success: function (response) {
                    if (response.success) {
                        location.reload();
                    } else {
                        alert('Failed to edit chat');
                    }
                }
            });
        }

        function addParticipant(chatId) {
            var participantId = $('#addParticipant').val();

            $.ajax({
                url: '/Chats/AddParticipant',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    ChatId: chatId,
                    ParticipantId: participantId
                }),
                success: function (response) {
                    if (response.success) {
                        location.reload();
                    } else {
                        alert('Failed to add participant');
                    }
                }
            });
        }
    </script>
}
